{{ define "main" }}
  <main id="publications" class="container">
    <h1>Publications</h1>

    {{/* Load items from data/publications.zotero.json:
         site.Data["publications"]["zotero"] (raw array or {items:[]}) */}}
    {{ $items := slice }}
    {{ with (index (site.Data) "publications") }}
      {{ with (index . "zotero") }}
        {{ if (index . "items") }}
          {{ $items = (index . "items") }}
        {{ else }}
          {{ $items = . }}
        {{ end }}
      {{ end }}
    {{ end }}

    {{ if lt (len $items) 1 }}
      <p>No publications yet.</p>
    {{ else }}
      {{/* Group by year */}}
      {{ $byYear := dict }}
      {{ range $it := $items }}
        {{ $year := "" }}
        {{ with (index $it "issued") }}
          {{ $dp := index . "date-parts" }}
          {{ if and $dp (ge (len $dp) 1) (ge (len (index $dp 0)) 1) }}
            {{ $year = printf "%v" (index (index $dp 0) 0) }}
          {{ else }}
            {{ with (index . "raw") }}{{ $year = printf "%v" . }}{{ end }}
          {{ end }}
        {{ end }}
        {{ if not $year }}{{ $year = "No year" }}{{ end }}

        {{ $bucket := index $byYear $year }}
        {{ if not $bucket }}
          {{ $byYear = merge $byYear (dict $year (slice $it)) }}
        {{ else }}
          {{ $byYear = merge $byYear (dict $year (append $bucket $it)) }}
        {{ end }}
      {{ end }}

      {{/* Sort years desc and render */}}
      {{ $years := slice }}
      {{ range $k, $_ := $byYear }}{{ $years = $years | append $k }}{{ end }}
      {{ $years = sort $years "value" "desc" }}

      {{ range $y := $years }}
        <h2 class="pubs-year">{{ $y }}</h2>
        <ol class="pubs-list">
          {{ range $pub := (index $byYear $y) }}
            <li class="pub">
              <span class="pub-title">{{ $pub.title }}</span>
              {{ with (index $pub "author") }}
                <span class="pub-authors"> â€” 
                  {{ range $i, $a := . }}
                    {{ if gt $i 0 }}, {{ end }}{{ $a.family }}{{ with $a.given }} {{ . }}{{ end }}
                  {{ end }}
                </span>
              {{ end }}
              {{ with (index $pub "container-title") }}<span class="pub-venue">, {{ . }}</span>{{ end }}
              {{ $yInline := "" }}
              {{ with (index $pub "issued") }}
                {{ $dp := index . "date-parts" }}
                {{ if and $dp (ge (len $dp) 1) (ge (len (index $dp 0)) 1) }}
                  {{ $yInline = printf "%v" (index (index $dp 0) 0) }}
                {{ else }}
                  {{ with (index . "raw") }}{{ $yInline = printf "%v" . }}{{ end }}
                {{ end }}
              {{ end }}
              {{ if $yInline }}<span class="pub-year"> ({{ $yInline }})</span>{{ end }}
              {{ with (index $pub "DOI") }}<a class="pub-link" href="https://doi.org/{{ . }}" target="_blank" rel="noopener">DOI</a>{{ end }}
              {{ with (index $pub "URL") }}<a class="pub-link" href="{{ . }}" target="_blank" rel="noopener">Link</a>{{ end }}
            </li>
          {{ end }}
        </ol>
      {{ end }}
    {{ end }}
  </main>
{{ end }}
