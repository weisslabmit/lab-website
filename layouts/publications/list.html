{{ define "main" }}
  <main id="publications" class="container">
    <h1>Publications</h1>

    {{/* Read JSON file directly to avoid any site.Data/mount issues */}}
    {{ $raw := "" }}
    {{ with readFile "data/publications.zotero.json" }}{{ $raw = . }}{{ end }}

    {{ if not $raw }}
      <p>No publications yet.</p>
    {{ else }}
      {{ $items := $raw | transform.Unmarshal }}
      {{ if lt (len $items) 1 }}
        <p>No publications yet.</p>
      {{ else }}

        {{/* -------- Group by year (robust: always coerce bucket to a slice) -------- */}}
        {{ $byYear := dict }}
        {{ range $it := $items }}
          {{/* extract year from issued.date-parts or issued.raw */}}
          {{ $year := "" }}
          {{ with (index $it "issued") }}
            {{ $dp := index . "date-parts" }}
            {{ if and $dp (gt (len $dp) 0) (gt (len (index $dp 0)) 0) }}
              {{ $year = printf "%v" (index (index $dp 0) 0) }}
            {{ else }}
              {{ with (index . "raw") }}{{ $year = printf "%v" . }}{{ end }}
            {{ end }}
          {{ end }}
          {{ if not $year }}{{ $year = "No year" }}{{ end }}

          {{/* get existing bucket; if not a slice, wrap it into a slice */}}
          {{ $existing := index $byYear $year }}
          {{ $bucket := slice }}
          {{ if $existing }}
            {{ if (reflect.IsSlice $existing) }}
              {{ $bucket = $existing }}
            {{ else }}
              {{ $bucket = slice $existing }}
            {{ end }}
          {{ end }}
          {{ $bucket = $bucket | append $it }}
          {{ $byYear = merge $byYear (dict $year $bucket) }}
        {{ end }}

        {{/* -------- Sort years desc and render -------- */}}
        {{ $years := slice }}
        {{ range $k, $_ := $byYear }}{{ $years = $years | append $k }}{{ end }}
        {{ $years = sort $years "value" "desc" }}

        {{ range $y := $years }}
          <h2 class="pubs-year">{{ $y }}</h2>
          <ol class="pubs-list">
            {{ range $pub := (index $byYear $y) }}
              {{ $t := index $pub "title" }}
              {{ $au := index $pub "author" }}
              {{ $ct := index $pub "container-title" }}
              {{ $iss := index $pub "issued" }}
              {{ $doi := index $pub "DOI" }}
              {{ $url := index $pub "URL" }}
              {{ $typ := index $pub "type" }}

              <li class="pub">
                <span class="pub-title">{{ $t }}</span>

                {{ with $au }}
                  <span class="pub-authors">
                    —
                    {{ range $i, $a := . }}
                      {{ if gt $i 0 }}, {{ end }}
                      {{ index $a "family" }}{{ with (index $a "given") }} {{ . }}{{ end }}
                    {{ end }}
                  </span>
                {{ end }}

                {{ with $ct }}<span class="pub-venue">, {{ . }}</span>{{ end }}

                {{ $yInline := "" }}
                {{ with $iss }}
                  {{ $dp := index . "date-parts" }}
                  {{ if and $dp (gt (len $dp) 0) (gt (len (index $dp 0)) 0) }}
                    {{ $yInline = printf "%v" (index (index $dp 0) 0) }}
                  {{ else }}
                    {{ with (index . "raw") }}{{ $yInline = printf "%v" . }}{{ end }}
                  {{ end }}
                {{ end }}
                {{ if $yInline }}<span class="pub-year"> ({{ $yInline }})</span>{{ end }}

                {{ with $doi }}<a class="pub-link" href="https://doi.org/{{ . }}" target="_blank" rel="noopener">DOI</a>{{ end }}
                {{ with $url }}<a class="pub-link" href="{{ . }}" target="_blank" rel="noopener">Link</a>{{ end }}
                {{ with $typ }}<span class="pub-type"> · {{ . }}</span>{{ end }}
              </li>
            {{ end }}
          </ol>
        {{ end }}
      {{ end }}
    {{ end }}
  </main>
{{ end }}
