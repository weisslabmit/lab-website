{{/* ================= PEOPLE SECTION (safe, PI first, fixed order) ================= */}}

{{/* Load people pages safely */}}
{{ $people := slice }}
{{ with .Site.GetPage "section" "people" }}
  {{ $people = .Pages }}
{{ end }}

{{ if gt (len $people) 0 }}
<section id="people" class="people-section">

  {{/* Buckets weâ€™ll fill */}}
  {{ $s := newScratch }}
  {{ $known := slice "PI" "Staff" "PhD Students" "Postdocs" "Other" "Undergrads" }}
  {{ range $known }}{{ $s.Set . (slice) }}{{ end }}

  {{/* Helper to infer category from role text (very simple substr checks) */}}
  {{ range $people }}
    {{ $cat := .Params.category }}
    {{ if not (in $known $cat) }}
      {{ $role := lower (default "" .Params.role) }}
      {{ if or (in $role "pi") (in $role "principal investigator") (in $role "professor") }}
        {{ $cat = "PI" }}
      {{ else if in $role "postdoc" }}
        {{ $cat = "Postdocs" }}
      {{ else if or (in $role "phd") (in $role "doctoral") (in $role "doctorand") (in $role "graduate") }}
        {{ $cat = "PhD Students" }}
      {{ else if or (in $role "undergrad") (in $role "bsc") (in $role "ba") (in $role "intern") (in $role "ug") }}
        {{ $cat = "Undergrads" }}
      {{ else if or (in $role "staff") (in $role "engineer") (in $role "technician") (in $role "manager") (in $role "coordinator") (in $role "admin") }}
        {{ $cat = "Staff" }}
      {{ else }}
        {{ $cat = "Other" }}
      {{ end }}
    {{ end }}
    {{ $s.Add $cat (slice .) }}
  {{ end }}

  {{/* ------------------- PI (first, highlighted) ------------------- */}}
  {{ $piList := $s.Get "PI" | default (slice) }}
  {{ if gt (len $piList) 0 }}
    <h3 class="people-group-title">PI</h3>
    <div class="people-grid">
      {{ $pi := index (sort $piList "Weight") 0 }}
      <article class="person-card person-highlight">
        <a href="{{ $pi.RelPermalink }}" class="image avatar" aria-label="{{ $pi.Title }}">
          {{ with $pi.Params.image }}
            <img src="{{ . | relURL }}" alt="{{ $pi.Title }}">
          {{ else }}
            <img src="{{ "images/avatar.jpg" | relURL }}" alt="{{ $pi.Title }}">
          {{ end }}
        </a>
        <div class="content">
          <h3>{{ $pi.Title }}</h3>
          {{ with $pi.Params.role }}<div class="role">{{ . }}</div>{{ end }}
          {{ with $pi.Params.summary }}<p class="bio">{{ . }}</p>{{ end }}

          {{ with $pi.Params.email }}
            {{ $e := . }}
            {{ $e = replace $e "@" " (at) " }}
            {{ $e = replace $e "." " (dot) " }}
            <span class="person-email">{{ $e }}</span>
          {{ end }}

          <div class="person-links">
            {{ with $pi.Params.website }}<a href="{{ . }}" target="_blank" rel="noopener" aria-label="Website"><i class="icon solid fa-globe"></i></a>{{ end }}
            {{ with $pi.Params.scholar }}<a href="{{ . }}" target="_blank" rel="noopener" aria-label="Google Scholar"><i class="icon solid fa-graduation-cap"></i></a>{{ end }}
            {{ with $pi.Params.github  }}<a href="{{ . }}" target="_blank" rel="noopener" aria-label="GitHub"><i class="icon brands fa-github"></i></a>{{ end }}
          </div>
        </div>
      </article>
    </div>
  {{ end }}

  {{/* ------------- Remaining categories in fixed order ------------- */}}
  {{ $order := slice "Staff" "PhD Students" "Postdocs" "Other" "Undergrads" }}
  {{ range $order }}
    {{ $items := $s.Get . | default (slice) }}
    {{ if gt (len $items) 0 }}
      <h3 class="people-group-title">{{ . }}</h3>
      <div class="people-grid">
        {{ range sort $items "Weight" }}
          <article class="person-card">
            <a href="{{ .RelPermalink }}" class="image avatar" aria-label="{{ .Title }}">
              {{ with .Params.image }}
                <img src="{{ . | relURL }}" alt="{{ .Title }}">
              {{ else }}
                <img src="{{ "images/avatar.jpg" | relURL }}" alt="{{ .Title }}">
              {{ end }}
            </a>

            <h3>{{ .Title }}</h3>
            {{ with .Params.role }}<div class="role">{{ . }}</div>{{ end }}
            {{ with .Params.summary }}<p class="bio">{{ . }}</p>{{ end }}

            {{ with .Params.email }}
              {{ $e := . }}
              {{ $e = replace $e "@" " (at) " }}
              {{ $e = replace $e "." " (dot) " }}
              <span class="person-email">{{ $e }}</span>
            {{ end }}

            <div class="person-links">
              {{ with .Params.website }}<a href="{{ . }}" target="_blank" rel="noopener" aria-label="Website"><i class="icon solid fa-globe"></i></a>{{ end }}
              {{ with .Params.scholar }}<a href="{{ . }}" target="_blank" rel="noopener" aria-label="Google Scholar"><i class="icon solid fa-graduation-cap"></i></a>{{ end }}
              {{ with .Params.github  }}<a href="{{ . }}" target="_blank" rel="noopener" aria-label="GitHub"><i class="icon brands fa-github"></i></a>{{ end }}
            </div>
          </article>
        {{ end }}
      </div>
    {{ end }}
  {{ end }}

</section>
{{ else }}
<!-- people-section: no people found (content/people/*). -->
{{ end }}
