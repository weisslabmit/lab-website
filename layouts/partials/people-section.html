{{/* ========= PEOPLE SECTION (PI first; category fallback from role) ========= */}}

{{/* Find people pages robustly */}}
{{ $root := site.GetPage "section" "people" | default (site.GetPage "people") }}
{{ $bySection := where site.Pages "Section" "people" }}
{{ $all := cond (and $root (gt (len $root.Pages) 0)) $root.Pages $bySection }}

{{/* Helper: map a page to a category. If .Params.category is missing, infer from .Params.role */}}
{{- define "getCat" -}}
  {{- $p := . -}}
  {{- with $p.Params.category -}}
    {{- . -}}
  {{- else -}}
    {{- $r := lower (default "" $p.Params.role) -}}
    {{- if (findRE "(^|\\b)(pi|principal investigator|professor)(\\b|$)" $r) -}}PI
    {{- else if (findRE "postdoc" $r) -}}Postdocs
    {{- else if (findRE "phd|doctoral|doctorand|grad(uate)?" $r) -}}PhD Students
    {{- else if (findRE "undergrad|u\\/?g|bsc|ba|intern" $r) -}}Undergrads
    {{- else if (findRE "staff|engineer|technician|manager|coordinator|admin" $r) -}}Staff
    {{- else -}}Other
    {{- end -}}
  {{- end -}}
{{- end }}

{{ if gt (len $all) 0 }}
<section id="people" class="people-section">
  <!-- DEBUG: found {{ len $all }} people pages -->

  {{/* Desired order */}}
  {{ $order := slice "PI" "Staff" "PhD Students" "Postdocs" "Other" "Undergrads" }}

  {{/* ---------------- PI (first, highlighted) ---------------- */}}
  {{ $pi := nil }}
  {{ range $all.ByWeight }}
    {{- if eq (trim (template "getCat" .)) "PI" -}}
      {{- $pi = . -}}
      {{- break -}}
    {{- end -}}
  {{ end }}

  {{ if $pi }}
    <h3 class="people-group-title">PI</h3>
    <div class="people-grid">
      <article class="person-card person-highlight">
        <a href="{{ $pi.RelPermalink }}" class="image avatar" aria-label="{{ $pi.Title }}">
          {{ with $pi.Params.image }}
            <img src="{{ . | relURL }}" alt="{{ $pi.Title }}">
          {{ else }}
            <img src="{{ "images/avatar.jpg" | relURL }}" alt="{{ $pi.Title }}">
          {{ end }}
        </a>

        <div class="content">
          <h3>{{ $pi.Title }}</h3>
          {{ with $pi.Params.role }}<div class="role">{{ . }}</div>{{ end }}
          {{ with $pi.Params.summary }}<p class="bio">{{ . }}</p>{{ end }}

          {{ with $pi.Params.email }}
            {{ $safe := replace (replace . "@" " (at) ") "." " (dot) " }}
            <span class="person-email">{{ $safe }}</span>
          {{ end }}

          <div class="person-links">
            {{ with $pi.Params.website }}<a href="{{ . }}" target="_blank" rel="noopener" aria-label="Website"><i class="icon solid fa-globe"></i></a>{{ end }}
            {{ with $pi.Params.scholar }}<a href="{{ . }}" target="_blank" rel="noopener" aria-label="Google Scholar"><i class="icon solid fa-graduation-cap"></i></a>{{ end }}
            {{ with $pi.Params.github  }}<a href="{{ . }}" target="_blank" rel="noopener" aria-label="GitHub"><i class="icon brands fa-github"></i></a>{{ end }}
          </div>
        </div>
      </article>
    </div>
  {{ end }}

  {{/* --------------- The rest, in fixed order (skipping PI) --------------- */}}
  {{ range $order }}
    {{- $cat := . -}}
    {{- if ne $cat "PI" -}}
      {{- $items := slice -}}
      {{- range $all.ByWeight -}}
        {{- $found := trim (template "getCat" .) -}}
        {{- if eq $found $cat -}}
          {{- $items = $items | append . -}}
        {{- end -}}
      {{- end -}}

      {{ if gt (len $items) 0 }}
        <h3 class="people-group-title">{{ $cat }}</h3>
        <div class="people-grid">
          {{ range $items }}
            <article class="person-card">
              <a href="{{ .RelPermalink }}" class="image avatar" aria-label="{{ .Title }}">
                {{ with .Params.image }}
                  <img src="{{ . | relURL }}" alt="{{ .Title }}">
                {{ else }}
                  <img src="{{ "images/avatar.jpg" | relURL }}" alt="{{ .Title }}">
                {{ end }}
              </a>

              <h3>{{ .Title }}</h3>
              {{ with .Params.role }}<div class="role">{{ . }}</div>{{ end }}
              {{ with .Params.summary }}<p class="bio">{{ . }}</p>{{ end }}

              {{ with .Params.email }}
                {{ $safe := replace (replace . "@" " (at) ") "." " (dot) " }}
                <span class="person-email">{{ $safe }}</span>
              {{ end }}

              <div class="person-links">
                {{ with .Params.website }}<a href="{{ . }}" target="_blank" rel="noopener" aria-label="Website"><i class="icon solid fa-globe"></i></a>{{ end }}
                {{ with .Params.scholar }}<a href="{{ . }}" target="_blank" rel="noopener" aria-label="Google Scholar"><i class="icon solid fa-graduation-cap"></i></a>{{ end }}
                {{ with .Params.github  }}<a href="{{ . }}" target="_blank" rel="noopener" aria-label="GitHub"><i class="icon brands fa-github"></i></a>{{ end }}
              </div>
            </article>
          {{ end }}
        </div>
      {{ end }}
    {{- end -}}
  {{ end }}

</section>
{{ else }}
<!-- people-section: NO pages found in Section 'people'. Check content/people/* -->
{{ end }}
