<!-- Footer -->
<footer class="wrapper style1 align-center">
    <div class="inner">
        <ul class="icons">
            {{ with .Site.Params.social.github }}<li><a target="_blank" href="{{.}}" class="icon brands style2 fa-github"><span class="label">Github</span></a></li>{{end}}
            {{ with .Site.Params.social.twitter }}<li><a target="_blank" href="{{.}}" class="icon brands style2 fa-twitter"><span class="label">Twitter</span></a></li>{{end}}
            {{ with .Site.Params.social.instagram }}<li><a target="_blank" href="{{.}}" class="icon brands style2 fa-instagram"><span class="label">Instagram</span></a></li>{{end}}
            {{ with .Site.Params.social.linkedin }}<li><a target="_blank" href="{{.}}" class="icon brands style2 fa-linkedin"><span class="label">LinkedIn</span></a></li>{{end}}
            {{ with .Site.Params.social.email }}<li><a target="_blank" href="mailto:{{.}}" class="fav icon style2 fa-envelope"><span class="label">Email</span></a></li>{{end}}
        </ul>
        <p>Hugo Story &copy; 2020 <a target="_blank" href="https://github.com/caressofsteel/">CaressOfSteel</a><span class="footerspacer icon fa-diamond"></span>
            Ported from <a target="_blank" href="https://html5up.net/uploads/demos/story/">Story</a> by HTML5UP<span class="footerspacer icon fa-diamond"></span>
            Images courtesy of <a target="_blank" href="https://unsplash.com">Unsplash</a></p>
</div>
</footer>

<script>
(function () {
  const nav = document.getElementById('floating-nav');
  if (!nav) return;

  const inner  = nav.querySelector('.floating-nav__inner');
  const links  = Array.from(nav.querySelectorAll('a[data-scroll]'));
  const ids    = links
    .map(a => a.getAttribute('href'))
    .filter(h => h && h.startsWith('#'))
    .map(h => h.slice(1));
  const sections = ids
    .map(id => document.getElementById(id))
    .filter(Boolean);

  const banner = document.getElementById('banner');

  /* --- Show/hide nav only based on banner visibility --- */
  function showNav() { nav.classList.add('is-visible'); }
  function hideNav() { nav.classList.remove('is-visible'); }

  if (banner) {
    const vis = new IntersectionObserver(([entry]) => {
      if (entry && entry.isIntersecting && entry.intersectionRatio > 0.2) hideNav();
      else showNav();
    }, { threshold: [0, 0.2, 0.4] });
    vis.observe(banner);
  } else {
    showNav();
  }

  /* --- Active link on scroll (no custom scrolling, no offsets) --- */
  function setActive(id) {
    let any = false;
    links.forEach(a => {
      const active = (a.getAttribute('href') === '#' + id);
      a.classList.toggle('is-active', active);
      any = any || active;
    });
    inner.classList.toggle('has-active', any);
  }

  const spy = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) setActive(entry.target.id);
    });
  }, {
    // “middle of viewport” counts as active
    rootMargin: '-45% 0px -45% 0px',
    threshold: 0
  });

  sections.forEach(sec => spy.observe(sec));
})();
</script>


<!-- Prewarm the timeline file so it’s cached when needed -->
<link rel="preload" href='{{ "embeds/timeline-lab/index.html" | relURL }}' as="document">
<link rel="prefetch" href='{{ "embeds/timeline-lab/index.html" | relURL }}' as="document">

<script>
(function () {
  const iframe = document.getElementById('lab-timeline');
  const timelineBlock = document.getElementById('research-timeline');
  if (!iframe || !timelineBlock) return;

  const wanted = iframe.getAttribute('data-src');
  let loaded = false;

  function loadTimeline() {
    if (loaded) return;
    loaded = true;
    iframe.src = wanted;
    if (io) io.disconnect();
  }

  // 1️⃣ Load if "Research" link is clicked
  const researchLink =
    document.querySelector('#floating-nav a[href="#research"]') ||
    document.querySelector('a[href="#research"][data-scroll]');
  if (researchLink) researchLink.addEventListener('click', loadTimeline, { once: true });

  // 2️⃣ Load if user lands directly on #research or #research-timeline
  function checkHash() {
    if (location.hash === '#research' || location.hash === '#research-timeline') loadTimeline();
  }
  checkHash();
  window.addEventListener('hashchange', checkHash);

  // 3️⃣ Load immediately once #research-timeline becomes visible
  const io = new IntersectionObserver((entries) => {
    if (loaded) return;
    for (const e of entries) {
      if (e.isIntersecting) { loadTimeline(); break; }
    }
  }, { threshold: 0 });

  io.observe(timelineBlock);
})();
</script>

<script>
(function () {
  const loader   = document.getElementById('timeline-loader');
  const timeline = document.getElementById('lab-timeline');
  const research = document.getElementById('research');
  if (!loader || !timeline || !research) return;

  // --- Prewarm the spinner image (non-blocking)
  const spImg = loader.querySelector('.timeline-frame__spinner[src]');
  if (spImg && spImg.getAttribute('src')) {
    const pre = new Image();
    pre.src = spImg.getAttribute('src');
  }

  let shown = false;     // ensure we only show once
  let armed = false;     // don’t trigger at initial page load

  // Arm on first user scroll (natural entry into the section)
  const armOnScroll = () => { armed = true; window.removeEventListener('scroll', armOnScroll); };
  window.addEventListener('scroll', armOnScroll, { once: true, passive: true });

  // If we load directly at #research (or #research in hash), arm immediately
  window.addEventListener('load', () => {
    if (location.hash && location.hash.replace('#','') === 'research') {
      armed = true;
    }
  });

  // Also arm if they click a link to #research (from your floating menu)
  document.addEventListener('click', (e) => {
    const a = e.target.closest('a[href^="#"]');
    if (!a) return;
    const h = a.getAttribute('href');
    if (h === '#research') armed = true;
  }, { passive: true });

  // Show/hide helpers
  function showSpinner() {
    if (shown) return;
    shown = true;
    loader.classList.add('is-visible');

    // Hide after ~1s; adjust if you want longer/shorter
    setTimeout(() => {
      loader.classList.remove('is-visible');
    }, 2300);
  }

  // Trigger as soon as ANY pixel of the research section is visible, but only after armed
  const io = new IntersectionObserver((entries) => {
    const e = entries[0];
    if (!e) return;
    if (armed && e.isIntersecting && !shown) {
      showSpinner();
      io.disconnect();
    }
  }, { threshold: 0.001 });

  io.observe(research);
})();
</script>
