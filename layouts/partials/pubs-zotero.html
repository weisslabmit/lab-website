{{/* Homepage Publications Section (year-grouped, sorted by date, linked titles)
   - Reads data/publications.zotero.json directly (top-level array)
   - Tabs: Publications(articles+preprints) / Patents / Other(everything else)
   - Authors as initials + last name
   - Preprints labeled "Preprint"
*/}}

{{ $raw := "" }}
{{ with readFile "data/publications.zotero.json" }}{{ $raw = . }}{{ end }}
{{ if not $raw }}{{ else }}
  {{ $items := $raw | transform.Unmarshal }}
  {{ if lt (len $items) 1 }}{{ else }}

  {{/* --- Categorize (Publications = peer-reviewed + preprints) --- */}}
  {{ $pubTypes := slice "article-journal" "journal-article" "article" "preprint" }}
  {{ $pubs := slice }} {{ $patents := slice }} {{ $others := slice }}
  {{ range $it := $items }}
    {{ $typ := index $it "type" | default "" | lower }}
    {{ if eq $typ "patent" }}
      {{ $patents = $patents | append $it }}
    {{ else if in $pubTypes $typ }}
      {{ $pubs = $pubs | append $it }}
    {{ else }}
      {{ $others = $others | append $it }}
    {{ end }}
  {{ end }}

  {{/* --- Group by year (coerce bucket to slice) --- */}}
  {{ $pubsByYear := dict }}
  {{ range $it := $pubs }}
    {{ $y := "" }}
    {{ with (index $it "issued") }}
      {{ $dp := index . "date-parts" }}
      {{ if and $dp (gt (len $dp) 0) (gt (len (index $dp 0)) 0) }}
        {{ $y = printf "%v" (index (index $dp 0) 0) }}
      {{ else }}{{ with (index . "raw") }}{{ $y = printf "%v" . }}{{ end }}{{ end }}
    {{ end }}
    {{ if not $y }}{{ $y = "No year" }}{{ end }}
    {{ $ex := index $pubsByYear $y }} {{ $bucket := slice }}
    {{ if $ex }}{{ if (reflect.IsSlice $ex) }}{{ $bucket = $ex }}{{ else }}{{ $bucket = slice $ex }}{{ end }}{{ end }}
    {{ $bucket = $bucket | append $it }}
    {{ $pubsByYear = merge $pubsByYear (dict $y $bucket) }}
  {{ end }}

  {{ $patByYear := dict }}
  {{ range $it := $patents }}
    {{ $y := "" }}
    {{ with (index $it "issued") }}
      {{ $dp := index . "date-parts" }}
      {{ if and $dp (gt (len $dp) 0) (gt (len (index $dp 0)) 0) }}
        {{ $y = printf "%v" (index (index $dp 0) 0) }}
      {{ else }}{{ with (index . "raw") }}{{ $y = printf "%v" . }}{{ end }}{{ end }}
    {{ end }}
    {{ if not $y }}{{ $y = "No year" }}{{ end }}
    {{ $ex := index $patByYear $y }} {{ $bucket := slice }}
    {{ if $ex }}{{ if (reflect.IsSlice $ex) }}{{ $bucket = $ex }}{{ else }}{{ $bucket = slice $ex }}{{ end }}{{ end }}
    {{ $bucket = $bucket | append $it }}
    {{ $patByYear = merge $patByYear (dict $y $bucket) }}
  {{ end }}

  {{ $othByYear := dict }}
  {{ range $it := $others }}
    {{ $y := "" }}
    {{ with (index $it "issued") }}
      {{ $dp := index . "date-parts" }}
      {{ if and $dp (gt (len $dp) 0) (gt (len (index $dp 0)) 0) }}
        {{ $y = printf "%v" (index (index $dp 0) 0) }}
      {{ else }}{{ with (index . "raw") }}{{ $y = printf "%v" . }}{{ end }}{{ end }}
    {{ end }}
    {{ if not $y }}{{ $y = "No year" }}{{ end }}
    {{ $ex := index $othByYear $y }} {{ $bucket := slice }}
    {{ if $ex }}{{ if (reflect.IsSlice $ex) }}{{ $bucket = $ex }}{{ else }}{{ $bucket = slice $ex }}{{ end }}{{ end }}
    {{ $bucket = $bucket | append $it }}
    {{ $othByYear = merge $othByYear (dict $y $bucket) }}
  {{ end }}

  {{/* --- Sorted year lists (desc) --- */}}
  {{ $pubYears := slice }}{{ range $k, $_ := $pubsByYear }}{{ $pubYears = $pubYears | append $k }}{{ end }}{{ $pubYears = sort $pubYears "value" "desc" }}
  {{ $patYears := slice }}{{ range $k, $_ := $patByYear }}{{ $patYears = $patYears | append $k }}{{ end }}{{ $patYears = sort $patYears "value" "desc" }}
  {{ $othYears := slice }}{{ range $k, $_ := $othByYear }}{{ $othYears = $othYears | append $k }}{{ end }}{{ $othYears = sort $othYears "value" "desc" }}

  <style>
    .pubs-section{padding:2rem 0}
    .pubs-tabs{display:flex;gap:.6rem;margin-bottom:1rem;flex-wrap:wrap;justify-content:center}
    .pubs-tabs button{padding:.55rem 1rem;border:1px solid #d3d3d3;border-radius:.7rem;background:#fff;cursor:pointer;transition:.15s;box-shadow:0 1px 0 rgba(0,0,0,.03)}
    .pubs-tabs button:hover{background:#f6f6f6}
    .pubs-tabs button.active{background:#111;color:#fff;border-color:#111}
    .year-group{margin:1.5rem 0 1.25rem}
    .pubs-year{margin:.25rem 0 .75rem;font-weight:800;text-align:left}
    .pubs-list{list-style:none;padding-left:0;margin:0}
    .pub{margin:1rem 0 1.1rem;line-height:1.6}
    .pub-title{font-weight:700}
    .pub-title a{color:inherit;text-decoration:none;border-bottom:1px solid rgba(0,0,0,.1)}
    .pub-title a:hover{border-bottom-color:rgba(0,0,0,.35)}
    .pub-authors{color:#222}
    .pub-venue{font-style:italic;color:#444}
    .pub-year{color:#666}
    .pubs-footer{display:flex;gap:.6rem;margin-top:1.25rem;flex-wrap:wrap;justify-content:center}
    .pubs-footer a,.pubs-footer button{padding:.65rem 1.05rem;border:1px solid #d3d3d3;border-radius:.7rem;background:#fff;cursor:pointer;text-decoration:none;transition:.15s;min-width:150px;text-align:center}
    .pubs-footer a:hover,.pubs-footer button:hover{background:#f6f6f6}
    .pubs-footer .primary{background:#111;color:#fff;border-color:#111}
    .hidden{display:none}
  </style>

  <section id="publications" class="container pubs-section" data-show="10">
    <div class="pubs-tabs">
      <button class="active" data-tab="pubs">Publications</button>
      <button data-tab="patents">Patents</button>
      <button data-tab="others">Other</button>
    </div>

    {{/* === Publications Pane (articles + preprints) === */}}
    <div class="pubs-pane" id="pubs-pane">
      {{ range $y := $pubYears }}
        {{/* Build sortable rows for this year, sort by YYYY-MM-DD desc */}}
        {{ $rows := slice }}
        {{ range $it := (index $pubsByYear $y) }}
          {{ $yy := 0 }}{{ $mm := 0 }}{{ $dd := 0 }}
          {{ with (index $it "issued") }}
            {{ $dp := index . "date-parts" }}
            {{ if and $dp (gt (len $dp) 0) }}
              {{ $yy = index (index $dp 0) 0 | default 0 }}
              {{ if gt (len (index $dp 0)) 1 }}{{ $mm = index (index $dp 0) 1 | default 0 }}{{ end }}
              {{ if gt (len (index $dp 0)) 2 }}{{ $dd = index (index $dp 0) 2 | default 0 }}{{ end }}
            {{ end }}
          {{ end }}
          {{ $k := printf "%04d-%02d-%02d" $yy $mm $dd }}
          {{ $rows = $rows | append (dict "k" $k "m" $it) }}
        {{ end }}
        {{ $rows = sort $rows "k" "desc" }}

        <div class="year-group" data-year-group>
          <h3 class="pubs-year">{{ $y }}</h3>
          <ul class="pubs-list">
            {{ range $row := $rows }}
              {{ $it := index $row "m" }}
              {{ $t := index $it "title" }}
              {{ $au := index $it "author" }}
              {{ $ct := index $it "container-title" | default "" }}
              {{ $iss := index $it "issued" }}
              {{ $typ := index $it "type" | default "" | lower }}
              {{ $doi := index $it "DOI" }}
              {{ $url := index $it "URL" | default "" }}
              {{ $href := "" }}
              {{ if $doi }}{{ $href = printf "https://doi.org/%s" $doi }}{{ else if $url }}{{ $href = $url }}{{ end }}

              {{/* Detect preprints by type, venue, or URL */}}
              {{ $ctLow := lower $ct }}
              {{ $urlLow := lower $url }}
              {{ $isPre := or (eq $typ "preprint") (or (in $ctLow "arxiv") (or (in $ctLow "biorxiv") (or (in $ctLow "medrxiv") (or (in $ctLow "chemrxiv") (in $ctLow "research square"))))) }}
              {{ $isPre = or $isPre (or (in $urlLow "arxiv.org") (or (in $urlLow "biorxiv.org") (or (in $urlLow "medrxiv.org") (in $urlLow "chemrxiv.org")))) }}

              <li class="pub pub-item">
                <span class="pub-title">
                  {{ if $href }}<a href="{{ $href }}" target="_blank" rel="noopener">{{ $t }}</a>{{ else }}{{ $t }}{{ end }}
                </span>

                {{ with $au }}
                <span class="pub-authors"> â€”
                    {{ $n := len $au }}
                    {{ range $j, $a := $au }}
                    {{ $fam := index $a "family" | default "" }}
                    {{ $giv := index $a "given"  | default "" }}

                    {{/* Build initials from given name: "I. I." */}}
                    {{ $init := "" }}
                    {{ if $giv }}
                        {{ $parts := split $giv " " }}
                        {{ range $p := $parts }}
                        {{ if gt (len $p) 0 }}
                            {{ $init = printf "%s%s." $init (upper (substr $p 0 1)) }}
                        {{ end }}
                        {{ end }}
                    {{ end }}

                    {{/* Print as "I. Lastname" (or fallbacks) */}}
                    {{ if and $init $fam }}{{ $init }} {{ $fam }}
                    {{ else if $fam }}{{ $fam }}
                    {{ else }}{{ $giv }}
                    {{ end }}

                    {{/* Comma immediately after the name, no preceding space */}}
                    {{ if lt $j (sub $n 1) }}, {{ end }}
                    {{ end }}
                </span>
                {{ end }}

                {{ if $isPre }}
                  <span class="pub-venue">, Preprint</span>
                {{ else }}
                  {{ with $ct }} <span class="pub-venue">, {{ . }}</span>{{ end }}
                {{ end }}

                {{ with $iss }}
                  {{ $dp := index . "date-parts" }}
                  {{ if and $dp (gt (len $dp) 0) }}
                    <span class="pub-year"> ({{ index (index $dp 0) 0 }})</span>
                  {{ end }}
                {{ end }}
              </li>
            {{ end }}
          </ul>
        </div>
      {{ end }}
    </div>

    {{/* === Patents Pane === */}}
    <div class="pubs-pane hidden" id="patents-pane">
      {{ range $y := $patYears }}
        {{ $rows := slice }}
        {{ range $it := (index $patByYear $y) }}
          {{ $yy := 0 }}{{ $mm := 0 }}{{ $dd := 0 }}
          {{ with (index $it "issued") }}
            {{ $dp := index . "date-parts" }}
            {{ if and $dp (gt (len $dp) 0) }}
              {{ $yy = index (index $dp 0) 0 | default 0 }}
              {{ if gt (len (index $dp 0)) 1 }}{{ $mm = index (index $dp 0) 1 | default 0 }}{{ end }}
              {{ if gt (len (index $dp 0)) 2 }}{{ $dd = index (index $dp 0) 2 | default 0 }}{{ end }}
            {{ end }}
          {{ end }}
          {{ $k := printf "%04d-%02d-%02d" $yy $mm $dd }}
          {{ $rows = $rows | append (dict "k" $k "m" $it) }}
        {{ end }}
        {{ $rows = sort $rows "k" "desc" }}

        <div class="year-group" data-year-group>
          <h3 class="pubs-year">{{ $y }}</h3>
          <ul class="pubs-list">
            {{ range $row := $rows }}
              {{ $it := index $row "m" }}
              {{ $t := index $it "title" }}
              {{ $au := index $it "author" }}
              {{ $ct := index $it "container-title" | default "" }}
              {{ $iss := index $it "issued" }}
              {{ $typ := index $it "type" | default "" | lower }}
              {{ $doi := index $it "DOI" }}
              {{ $url := index $it "URL" | default "" }}
              {{ $href := "" }}
              {{ if $doi }}{{ $href = printf "https://doi.org/%s" $doi }}{{ else if $url }}{{ $href = $url }}{{ end }}

              <li class="pub pub-item">
                <span class="pub-title">
                  {{ if $href }}<a href="{{ $href }}" target="_blank" rel="noopener">{{ $t }}</a>{{ else }}{{ $t }}{{ end }}
                </span>

                {{ with $au }}
                  <span class="pub-authors">
                    â€”
                    {{ range $j, $a := . }}
                      {{ if gt $j 0 }}, {{ end }}
                      {{ $fam := index $a "family" | default "" }}
                      {{ $giv := index $a "given" | default "" }}
                      {{ $init := "" }}
                      {{ if $giv }}
                        {{ $parts := split $giv " " }}
                        {{ range $p := $parts }}
                          {{ if gt (len $p) 0 }}
                            {{ $init = printf "%s%s." $init (upper (substr $p 0 1)) }}
                          {{ end }}
                        {{ end }}
                      {{ end }}
                      {{ if and $init $fam }}{{ $init }} {{ $fam }}
                      {{ else if $fam }}{{ $fam }}
                      {{ else }}{{ $giv }}
                      {{ end }}
                    {{ end }}
                  </span>
                {{ end }}

                {{ with $ct }} <span class="pub-venue">, {{ . }}</span>{{ end }}
                {{ with $iss }}
                  {{ $dp := index . "date-parts" }}
                  {{ if and $dp (gt (len $dp) 0) }}
                    <span class="pub-year"> ({{ index (index $dp 0) 0 }})</span>
                  {{ end }}
                {{ end }}
              </li>
            {{ end }}
          </ul>
        </div>
      {{ end }}
    </div>

    {{/* === Others Pane === */}}
    <div class="pubs-pane hidden" id="others-pane">
      {{ range $y := $othYears }}
        {{ $rows := slice }}
        {{ range $it := (index $othByYear $y) }}
          {{ $yy := 0 }}{{ $mm := 0 }}{{ $dd := 0 }}
          {{ with (index $it "issued") }}
            {{ $dp := index . "date-parts" }}
            {{ if and $dp (gt (len $dp) 0) }}
              {{ $yy = index (index $dp 0) 0 | default 0 }}
              {{ if gt (len (index $dp 0)) 1 }}{{ $mm = index (index $dp 0) 1 | default 0 }}{{ end }}
              {{ if gt (len (index $dp 0)) 2 }}{{ $dd = index (index $dp 0) 2 | default 0 }}{{ end }}
            {{ end }}
          {{ end }}
          {{ $k := printf "%04d-%02d-%02d" $yy $mm $dd }}
          {{ $rows = $rows | append (dict "k" $k "m" $it) }}
        {{ end }}
        {{ $rows = sort $rows "k" "desc" }}

        <div class="year-group" data-year-group>
          <h3 class="pubs-year">{{ $y }}</h3>
          <ul class="pubs-list">
            {{ range $row := $rows }}
              {{ $it := index $row "m" }}
              {{ $t := index $it "title" }}
              {{ $au := index $it "author" }}
              {{ $ct := index $it "container-title" | default "" }}
              {{ $iss := index $it "issued" }}
              {{ $typ := index $it "type" | default "" | lower }}
              {{ $doi := index $it "DOI" }}
              {{ $url := index $it "URL" | default "" }}
              {{ $href := "" }}
              {{ if $doi }}{{ $href = printf "https://doi.org/%s" $doi }}{{ else if $url }}{{ $href = $url }}{{ end }}

              {{ $ctLow := lower $ct }}
              {{ $urlLow := lower $url }}
              {{ $isPre := or (eq $typ "preprint") (or (in $ctLow "arxiv") (or (in $ctLow "biorxiv") (or (in $ctLow "medrxiv") (or (in $ctLow "chemrxiv") (in $ctLow "research square"))))) }}
              {{ $isPre = or $isPre (or (in $urlLow "arxiv.org") (or (in $urlLow "biorxiv.org") (or (in $urlLow "medrxiv.org") (in $urlLow "chemrxiv.org")))) }}

              <li class="pub pub-item">
                <span class="pub-title">
                  {{ if $href }}<a href="{{ $href }}" target="_blank" rel="noopener">{{ $t }}</a>{{ else }}{{ $t }}{{ end }}
                </span>

                {{ with $au }}
                  <span class="pub-authors">
                    â€”
                    {{ range $j, $a := . }}
                      {{ if gt $j 0 }}, {{ end }}
                      {{ $fam := index $a "family" | default "" }}
                      {{ $giv := index $a "given" | default "" }}
                      {{ $init := "" }}
                      {{ if $giv }}
                        {{ $parts := split $giv " " }}
                        {{ range $p := $parts }}
                          {{ if gt (len $p) 0 }}
                            {{ $init = printf "%s%s." $init (upper (substr $p 0 1)) }}
                          {{ end }}
                        {{ end }}
                      {{ end }}
                      {{ if and $init $fam }}{{ $init }} {{ $fam }}
                      {{ else if $fam }}{{ $fam }}
                      {{ else }}{{ $giv }}
                      {{ end }}
                    {{ end }}
                  </span>
                {{ end }}

                {{ if $isPre }}
                  <span class="pub-venue">, Preprint</span>
                {{ else }}
                  {{ with $ct }} <span class="pub-venue">, {{ . }}</span>{{ end }}
                {{ end }}

                {{ with $iss }}
                  {{ $dp := index . "date-parts" }}
                  {{ if and $dp (gt (len $dp) 0) }}
                    <span class="pub-year"> ({{ index (index $dp 0) 0 }})</span>
                  {{ end }}
                {{ end }}
              </li>
            {{ end }}
          </ul>
        </div>
      {{ end }}
    </div>

    <div class="pubs-footer">
      <button id="btn-more" class="primary">Show 10 more</button>
      <a class="primary" href="/publications/">All publications</a>
      <a href="https://scholar.google.com/citations?user=st2YzBwAAAAJ&hl=en&oi=ao" target="_blank" rel="noopener">Google Scholar</a>
    </div>
  </section>

  <script>
    (function(){
      const root = document.getElementById('publications');
      if(!root) return;

      const panes = {
        pubs: document.getElementById('pubs-pane'),
        patents: document.getElementById('patents-pane'),
        others: document.getElementById('others-pane')
      };
      const tabs = root.querySelectorAll('.pubs-tabs button');
      const moreBtn = document.getElementById('btn-more');
      const pageSize = 10;
      let shown = parseInt(root.dataset.show || '10', 10);
      let active = 'pubs';

      function updateYearVisibility(pane){
        const groups = pane.querySelectorAll('[data-year-group]');
        groups.forEach(g=>{
          const items = g.querySelectorAll('.pub-item');
          const anyVisible = Array.from(items).some(li => !li.classList.contains('hidden'));
          g.classList.toggle('hidden', !anyVisible);
        });
      }

      function applyVisibility(){
        Object.keys(panes).forEach(k=>{
          const pane = panes[k];
          const show = (k === active);
          pane.classList.toggle('hidden', !show);

          if(show){
            const items = pane.querySelectorAll('.pub-item');
            items.forEach((li, idx)=> li.classList.toggle('hidden', idx >= shown));
            const anyHidden = Array.from(items).some((_, idx)=> idx >= shown);
            moreBtn.style.display = anyHidden ? '' : 'none';
            updateYearVisibility(pane); // hide year headings with no visible items
          }
        });
      }

      tabs.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          tabs.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          active = btn.getAttribute('data-tab');
          shown = pageSize; // reset on tab switch
          applyVisibility();
        });
      });

      moreBtn.addEventListener('click', ()=>{
        shown += pageSize;
        applyVisibility();
      });

      applyVisibility();
    })();
  </script>

  {{ end }}
{{ end }}
