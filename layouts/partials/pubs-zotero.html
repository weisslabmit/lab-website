{{/* Renders data/publications.zotero.json (CSL-JSON array) */}}
{{ $items := site.Data.publications_zotero }}

{{ if not $items }}
  <p>No publications yet.</p>
{{ else }}

  {{/* --- Build a map: year -> []items --- */}}
  {{ $byYear := dict }}

  {{ range $it := $items }}
    {{/* Derive year from issued.date-parts[0][0] or issued.raw */}}
    {{ $year := "" }}
    {{ $issued := index $it "issued" }}
    {{ if $issued }}
      {{ $dp := index $issued "date-parts" }}
      {{ if and $dp (ge (len $dp) 1) (ge (len (index $dp 0)) 1) }}
        {{ $year = printf "%v" (index (index $dp 0) 0) }}
      {{ else }}
        {{ $raw := index $issued "raw" }}
        {{ if $raw }}{{ $year = printf "%v" $raw }}{{ end }}
      {{ end }}
    {{ end }}
    {{ if not $year }}{{ $year = "No year" }}{{ end }}

    {{ $bucket := index $byYear $year }}
    {{ if not $bucket }}
      {{ $byYear = merge $byYear (dict $year (slice $it)) }}
    {{ else }}
      {{ $byYear = merge $byYear (dict $year (append $bucket $it)) }}
    {{ end }}
  {{ end }}

  {{/* --- Render years in descending order --- */}}
  {{ $years := slice }}
  {{ range $k, $_ := $byYear }}{{ $years = $years | append $k }}{{ end }}
  {{ $years = sort $years "value" "desc" }}

  {{ range $y := $years }}
    <h2 class="pubs-year">{{ $y }}</h2>
    <ol class="pubs-list">
      {{ range $pub := (index $byYear $y) }}
        <li class="pub">
          <span class="pub-title">{{ $pub.title }}</span>

          {{ with (index $pub "author") }}
            <span class="pub-authors">
              â€”
              {{ range $i, $a := . }}
                {{ if gt $i 0 }}, {{ end }}
                {{ $a.family }}{{ with $a.given }} {{ . }}{{ end }}
              {{ end }}
            </span>
          {{ end }}

          {{ with (index $pub "container-title") }}
            <span class="pub-venue">, {{ . }}</span>
          {{ end }}

          {{/* Recompute year for inline display (cheap) */}}
          {{ $yearInline := "" }}
          {{ with (index $pub "issued") }}
            {{ $dp := index . "date-parts" }}
            {{ if and $dp (ge (len $dp) 1) (ge (len (index $dp 0)) 1) }}
              {{ $yearInline = printf "%v" (index (index $dp 0) 0) }}
            {{ else }}
              {{ $raw := index . "raw" }}
